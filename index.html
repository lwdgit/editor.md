<!DOCTYPE html>
<html lang="zh" manifest="index.appcache">

<head>
    <meta charset="utf-8" />
    <title>Online Markdown</title>
    <link rel="stylesheet" href="./examples/css/style.css" />
    <link rel="stylesheet" href="./css/editormd.min.css" />
</head>

<body>
    <style>
    span.overflow {
        position: relative;
        left: 0;
        background: #fff;
    }
    </style>
    <div id="layout">
        <div id="test-editormd">
<textarea style="display:none;">
# Welcome to use Online Markdown Editor 
## Functions & Features: 
* Cmd+S to save the file 
* Cmd+P to print 
* Drag and drop a file into here to load it 
* paste image as base64 
* support markdown extend & flowchart 
* offline available

> Tips: Editor will auto save your code into localStorage


## More powerful functions:

#### GFM task list

- [x] GFM task list 1
- [x] GFM task list 2
- [ ] GFM task list 3
    - [ ] GFM task list 3-1
    - [ ] GFM task list 3-2
    - [ ] GFM task list 3-3
- [ ] GFM task list 4
    - [ ] GFM task list 4-1
    - [ ] GFM task list 4-2

[========]

### Emoji表情 :smiley:

> Blockquotes :star:

#### GFM task lists & Emoji & fontAwesome icon emoji & editormd logo emoji :editormd-logo-5x:

- [x] :smiley: @mentions, :smiley: #refs, [links](), **formatting**, and <del>tags</del> supported :editormd-logo:;
- [x] list syntax required (any unordered or ordered list supported) :editormd-logo-3x:;
- [x] [ ] :smiley: this is a complete item :smiley:;
- [ ] []this is an incomplete item [test link](#) :fa-star: @pandao; 
- [ ] [ ]this is an incomplete item :fa-star: :fa-gear:;
    - [ ] :smiley: this is an incomplete item [test link](#) :fa-star: :fa-gear:;
    - [ ] :smiley: this is  :fa-star: :fa-gear: an incomplete item [test link](#);
 
#### 反斜杠 Escape

\*literal asterisks\*

[========]
            
### 科学公式 TeX(KaTeX)

$$E=mc^2$$

行内的公式$$E=mc^2$$行内的公式，行内的$$E=mc^2$$公式。

$$x > y$$

$$\(\sqrt{3x-1}+(1+x)^2\)$$
                    
$$\sin(\alpha)^{\theta}=\sum_{i=0}^{n}(x^i + \cos(f))$$

多行公式：

```math
\displaystyle
\left( \sum\_{k=1}^n a\_k b\_k \right)^2
\leq
\left( \sum\_{k=1}^n a\_k^2 \right)
\left( \sum\_{k=1}^n b\_k^2 \right)
```

```katex
\displaystyle 
    \frac{1}{
        \Bigl(\sqrt{\phi \sqrt{5}}-\phi\Bigr) e^{
        \frac25 \pi}} = 1+\frac{e^{-2\pi}} {1+\frac{e^{-4\pi}} {
        1+\frac{e^{-6\pi}}
        {1+\frac{e^{-8\pi}}
         {1+\cdots} }
        } 
    }
```

```latex
f(x) = \int_{-\infty}^\infty
    \hat f(\xi)\,e^{2 \pi i \xi x}
    \,d\xi
```

### 分页符 Page break

> Print Test: Ctrl + P

[========]

### 绘制流程图 Flowchart

```flow
st=>start: 用户登陆
op=>operation: 登陆操作
cond=>condition: 登陆成功 Yes or No?
e=>end: 进入后台

st->op->cond
cond(yes)->e
cond(no)->op
```

[========]
                    
### 绘制序列图 Sequence Diagram
                    
```seq
Andrew->China: Says Hello 
Note right of China: China thinks\nabout it 
China-->Andrew: How are you? 
Andrew->>China: I am good thanks!
```

### End
</textarea>
        </div>
    </div>
    <script src="./examples/js/jquery.min.js"></script>
    <script src="./editormd.min.js"></script>
    <script type="text/javascript">
    var testEditor;
    $(function() {

        testEditor = editormd("test-editormd", {
            htmlDecode: true,
            width: "100%",
            height: window.outerHeight || document.body.clientHeight,
            syncScrolling: "single",
            path: "./lib/",
            emoji: true,
            taskList: true,
            tocm: true, // Using [TOCM]
            tex: true, // 开启科学公式TeX语言支持，默认关闭
            flowChart: true, // 开启流程图支持，默认关闭
            sequenceDiagram: true, // 开启时序/序列图支持，默认关闭,
            codeFold: false,
            dragDrop: true,
            allowDropFileTypes: ['images/jpeg'],
            foldImg: {
                rangeFinder: function(cm, line, hideEnd) {
                    line = line.line;
                    //console.log(line);
                    var lineText = cm.getLine(line),
                        at = lineText.length,
                        startChar, tokenType, start;
                        var baseEl = document.createElement('span'); baseEl.className = 'imgFold';
                     
                        if (lineText.indexOf('](') > -1 && (start = lineText.indexOf('![')) > -1) {
                            var reStructStr = '', offset = 0, imgsrc = '', endpos;
                            lineText = lineText.replace(/\![^\]]*\]\(([^)]+)\)/g, function(matches, src, pos, all) {
                                reStructStr = reStructStr || all;
                                pos += offset;
                                imgsrc = '<img src="' + src + '">';
                                reStructStr = reStructStr.substr(0, pos) + imgsrc + reStructStr.substr(endpos = pos + matches.length);
                                offset += (imgsrc.length - matches.length);
                            });
                            if (reStructStr) {
                                baseEl.innerHTML = reStructStr;
                                cm.options.foldImg.widget = baseEl;
                                return {
                                    from: {
                                        line: line,
                                        ch: start
                                    },
                                    to: {
                                        line: line,
                                        ch: endpos
                                    }
                                }
                            }
                        }
                }
            },
            onload: init
        });

        function initSave() {
            var autoSave = function(content) {
                content = testEditor.getMarkdown();
                localStorage.setItem('__tempMarkdown', content);
            }.bind(this);
            window.onbeforeunload = window.onunload = autoSave;
            document.addEventListener('visibilitychange', autoSave.bind(this));


            var URL = window.URL || window.webkitURL || window.mozURL || window.msURL;
            navigator.saveBlob = navigator.saveBlob || navigator.msSaveBlob || navigator.mozSaveBlob || navigator.webkitSaveBlob;
            window.saveAs = window.saveAs || window.webkitSaveAs || window.mozSaveAs || window.msSaveAs;
        }


        function init() {
            var Opts = {
                preview: function(script) {
                    var w = window.open('', '_blank', ''),
                        d = w.document;

                    var title = document.querySelector('.editormd-preview h1');
                    var head = '<title>' + (title ? title.textContent : '') + '</title>';
                    var links = document.querySelectorAll('link[href]');
                    for (var i = 0, l = links.length; i < l; i++) {
                        head += '<link rel="stylesheet" href="' + links[i].href + '">'
                    }
                    var content = document.querySelector('.editormd-preview').innerHTML;
                    if (script) {
                        content += '<script' + '>' + script + '<' + '/script>'; //这里有坑
                    }
                    d.open();
                    d.write('<html><head>' + head + '</head><body class="preview">' + content + '</div></body></html>');
                    d.close();
                },
                save: function() {
                    var title;
                    save(testEditor.getMarkdown(), ((title = document.querySelector('.editormd-preview h1')) ? title.textContent : 'unamed') + '.md');
                },

                print: function() {
                    Opts.preview('window.print()');
                }
            }
            this.addKeyMap({
                'Cmd-S': Opts.save,
                'Cmd-P': Opts.print
            });
            testEditor.cm.execCommand('foldImg');
            testEditor.cm.on('blur', function() {
                testEditor.cm.execCommand('foldImg');
            });
            var imgOnload = function(event) {
                testEditor.cm.replaceSelection('![](' + event.target.result + ')');
            };
            testEditor.cmElement.on('paste', function(e) {
                var items;
                if ((items = e.originalEvent.clipboardData.items).length) {
                    for (var i = 0, l = items.length; i < l; i++) {
                        if (items[i].type.match(/^image\//)) {
                            var reader = new FileReader();
                            reader.onload = imgOnload;
                            reader.readAsDataURL(items[i].getAsFile());
                        }
                    }
                }
            });
            testEditor.cmElement.on('drop', function(e) {
                var files = e.originalEvent.dataTransfer.files;
                for (var i = 0, l = files.length; i < l; i++) {
                    var file = files[i];
                    var reader = new FileReader();
                    if (file.type.indexOf('text') === -1) {
                        reader.readAsDataURL(file);
                        reader.onload = imgOnload;
                    }

                }
                e.preventDefault();
            });

            function save(code, name) {
                var blob = new Blob([code], {
                    type: 'text/plain'
                });
                if (window.saveAs) {
                    window.saveAs(blob, name);
                } else if (navigator.saveBlob) {
                    navigator.saveBlob(blob, name);
                } else {
                    url = URL.createObjectURL(blob);
                    var link = document.createElement("a");
                    link.setAttribute("href", url);
                    link.setAttribute("download", name);
                    var event = document.createEvent('MouseEvents');
                    event.initMouseEvent('click', true, true, window, 1, 0, 0, 0, 0, false, false, false, false, 0, null);
                    link.dispatchEvent(event);
                }
            }
            var markdown = localStorage.getItem('__tempMarkdown');
            if (markdown) {
                testEditor.setMarkdown(markdown);
            }
            initSave();
        }
    });
    </script>
</body>

</html>
